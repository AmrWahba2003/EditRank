<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>رفع فيديو | EditRank</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,sans-serif}
  body{background:#f0f2f5;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:15px}

  form{
    background:#fff;padding:25px;border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,.1);
    display:flex;flex-direction:column;gap:12px;width:100%;max-width:450px;position:relative
  }

  h2{margin-bottom:10px;text-align:center;color:#2575fc}
  input,textarea,select,button{
    width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:.95rem
  }

  textarea{resize:none}
  button{
    background:#2575fc;color:#fff;border:none;font-weight:700;cursor:pointer;transition:.3s
  }
  button:hover{background:#0053ba}
  button:disabled{background:#999;cursor:not-allowed}

  .timer{position:absolute;top:-25px;right:0;font-size:.85rem;color:#555}

  /* Responsive */
  @media(max-width:500px){
    form{padding:20px;gap:10px}
    h2{font-size:1.1rem}
  }
</style>
</head>
<body>

<form id="uploadForm">
  <div class="timer" id="timer">00:00</div>
  <h2>رفع فيديو جديد</h2>

  <input type="text" name="title" placeholder="عنوان الفيديو" required>
  <textarea name="description" placeholder="وصف الفيديو" rows="3"></textarea>

  <select name="category" id="categorySelect" required>
    <option value="">اختر الفئة</option>
  </select>

  <select name="subcategory" id="subcategorySelect" required>
    <option value="">اختر الفئة الفرعية</option>
  </select>

  <input type="file" name="video" accept="video/*" required>
  <button type="submit" id="uploadBtn">رفع الفيديو</button>
</form>

<script>
const token = localStorage.getItem('jwt');
if(!token) location.href='/';

const form=document.getElementById('uploadForm');
const uploadBtn=document.getElementById('uploadBtn');
const timerEl=document.getElementById('timer');
const categorySelect=document.getElementById('categorySelect');
const subcategorySelect=document.getElementById('subcategorySelect');

// جلب الفئات
async function loadCategories(){
  try{
    const res=await fetch('/categories',{headers:{Authorization:'Bearer '+token}});
    if(!res.ok) throw new Error('فشل جلب الفئات');
    const categories=await res.json();
    categories.forEach(cat=>{
      const opt=document.createElement('option');
      opt.value=cat.name;
      opt.textContent=cat.name;
      categorySelect.appendChild(opt);
    });
  }catch(err){console.error(err);}
}

// عند اختيار الفئة عرض الفئات الفرعية
categorySelect.addEventListener('change',async ()=>{
  const selected=categorySelect.value;
  subcategorySelect.innerHTML='<option value="">اختر الفئة الفرعية</option>';
  if(!selected) return;
  try{
    const res=await fetch('/categories',{headers:{Authorization:'Bearer '+token}});
    const categories=await res.json();
    const cat=categories.find(c=>c.name===selected);
    if(cat && cat.subcategories){
      cat.subcategories.forEach(sub=>{
        const opt=document.createElement('option');
        opt.value=sub; opt.textContent=sub;
        subcategorySelect.appendChild(opt);
      });
    }
  }catch(err){console.error(err);}
});

loadCategories();

// رفع الفيديو
form.addEventListener('submit',async e=>{
  e.preventDefault();
  uploadBtn.disabled=true; uploadBtn.textContent='جارٍ الرفع...';

  let seconds=0; timerEl.textContent='00:00';
  const interval=setInterval(()=>{
    seconds++;
    const m=String(Math.floor(seconds/60)).padStart(2,'0');
    const s=String(seconds%60).padStart(2,'0');
    timerEl.textContent=`${m}:${s}`;
  },1000);

  const formData=new FormData(form);

  try{
    const res=await fetch('/videos/upload',{
      method:'POST',
      headers:{Authorization:'Bearer '+token},
      body:formData
    });
    clearInterval(interval);
    const data=await res.json();
    if(res.ok){
      alert('تم رفع الفيديو بنجاح!');
      window.location.href='home.html';
    }else{
      alert(data.error||'حدث خطأ أثناء رفع الفيديو');
      uploadBtn.disabled=false; uploadBtn.textContent='رفع الفيديو';
      timerEl.textContent='00:00';
    }
  }catch(err){
    console.error(err);
    clearInterval(interval);
    alert('حدث خطأ أثناء رفع الفيديو');
    uploadBtn.disabled=false; uploadBtn.textContent='رفع الفيديو';
    timerEl.textContent='00:00';
  }
});
</script>

</body>
</html>
