<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | EditRank</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  background:#f0f2f5;
  font-family:'Segoe UI',Tahoma,sans-serif;
  margin:0;
  padding-top:60px;
}
header {
  background:#2575fc;
  color:#fff;
  position:fixed;
  top:0; left:0; right:0;
  height:60px;
  z-index:200;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 10px;
}
header h1 {
  font-size:1.5rem;
  display:flex;
  align-items:center;
  gap:8px;
}
.logo { width:40px; height:40px; background:url('logo.png') no-repeat center/contain; }
nav.flex-column { background:#fff; padding:10px; border-right:1px solid #ddd; }
nav.flex-column a { display:block; margin-bottom:8px; text-decoration:none; color:#000; }
.nav-toggle { display:none; font-size:1.5rem; cursor:pointer; }
.video-card { border-radius:12px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,.1); transition:transform .3s, box-shadow .3s; margin-bottom:20px; background:#fff; }
.video-card:hover { transform:translateY(-5px); box-shadow:0 10px 30px rgba(0,0,0,.2); }
.media-wrap { position:relative; width:100%; padding-top:56.25%; background:#000; }
.media-wrap video { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; background:#000; }
.actions button { margin-right:5px; margin-top:5px; }
.category-panel { margin-bottom:15px; }
@media(max-width:991px){
  nav.flex-column { display:none; position:fixed; top:60px; left:0; width:200px; height:100%; z-index:250; overflow-y:auto; box-shadow:2px 0 10px rgba(0,0,0,.2);}
  nav.flex-column.active { display:block; }
  .nav-toggle { display:block; color:#fff; }
}
</style>
</head>
<body>

<header class="d-flex align-items-center justify-content-between">
  <div class="d-flex align-items-center">
    <span class="nav-toggle">&#9776;</span>
    <h1 class="d-flex align-items-center"><div class="logo"></div> EditRank</h1>
  </div>
  <div class="d-flex align-items-center gap-2">
    <img id="profileImg" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨" class="rounded-circle" width="40" height="40">
    <span id="profileName" class="fw-bold"></span>
  </div>
</header>

<div class="d-flex">
  <!-- Sidebar -->
  <nav class="flex-column" id="sidebar">
    <a href="search.html">ğŸ” Ø¨Ø­Ø« Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
    <a href="#" id="profileLink">ğŸ‘¤ Profile</a>
    <a href="settings.html">âš™ï¸ Settings</a>
    <a href="upload.html">â¬†ï¸ Upload</a>
    <a href="/" class="text-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </nav>

  <!-- Content -->
  <div class="flex-grow-1 p-3">
    <div class="category-panel">
      <h3 class="text-primary">ØªØµÙÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
      <div class="mb-2">
        <select id="categorySelect" class="form-select form-select-sm">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
        </select>
      </div>
      <div class="mb-2">
        <select id="subcategorySelect" class="form-select form-select-sm">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©</option>
        </select>
      </div>
      <button id="filterBtn" class="btn btn-primary btn-sm">Ø¨Ø­Ø«</button>
    </div>
    <div class="row" id="videoGrid"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Sidebar toggle
const navToggle = document.querySelector('.nav-toggle');
const sidebar = document.getElementById('sidebar');
navToggle.addEventListener('click', ()=>{ sidebar.classList.toggle('active'); });

// Token and currentUser
const token = localStorage.getItem('jwt');
if(!token){ location.href = '/'; }
let currentUser = {};
try {
  const payload = JSON.parse(atob(token.split('.')[1]));
  currentUser = payload;
  const savedAvatar = localStorage.getItem('currentUserAvatar');
  if(savedAvatar) payload.avatar = savedAvatar;
  document.getElementById('profileImg').src = payload.avatar || '';
  document.getElementById('profileName').textContent = payload.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
} catch(e){ console.error('Invalid token', e); }

document.getElementById('profileLink').addEventListener('click', ()=>{ window.location.href=`profile.html?userId=${currentUser.id}`; });

// Escape HTML
function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// Create video card
function createVideoCard(video){
  const col = document.createElement('div');
  col.className='col-sm-6 col-md-4';
  const likedByMe = video.likedBy && video.likedBy.includes(currentUser.id);
  const likesCount = video.likedBy ? video.likedBy.length : 0;
  const deleteBtn = video.uploader?._id===currentUser.id ? `<button class="btn btn-danger btn-sm delete-btn">Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>` : '';
  col.innerHTML = `<div class="video-card" data-video-id="${video._id}">
    <div class="media-wrap"><video src="${escapeHtml(video.url)}" controls preload="metadata" playsinline></video></div>
    <div class="p-2">
      <h5 class="text-primary">${escapeHtml(video.title)}</h5>
      <p class="text-muted">${escapeHtml(video.description||'')}</p>
      <div class="text-secondary mb-2">Ø§Ù„ØªØµÙ†ÙŠÙ: ${escapeHtml(video.category||'')} / ${escapeHtml(video.subcategory||'')}</div>
      <div class="actions">
        <button class="btn btn-sm like-btn" style="background:${likedByMe?'#e53e3e':'#2575fc'};color:#fff;">
          ${likedByMe?'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ ğŸ’”':'Ø¥Ø¹Ø¬Ø§Ø¨ â¤ï¸'} ${likesCount}
        </button>
        ${deleteBtn}
      </div>
    </div>
  </div>`;
  return col;
}

// Load categories
async function loadCategories(){
  try{
    const res = await fetch('/categories', { headers:{Authorization:'Bearer '+token} });
    if(!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ÙØ¦Ø§Øª');
    const categories = await res.json();
    const catSel = document.getElementById('categorySelect');
    const subSel = document.getElementById('subcategorySelect');

    categories.forEach(cat=>{
      const opt = document.createElement('option');
      opt.value = cat.name;
      opt.textContent = cat.name;
      catSel.appendChild(opt);
    });

    catSel.addEventListener('change', ()=>{
      const selected = categories.find(c=>c.name === catSel.value);
      subSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©</option>';
      if(selected?.subcategories){
        selected.subcategories.forEach(sub=>{
          const opt = document.createElement('option');
          opt.value = sub;
          opt.textContent = sub;
          subSel.appendChild(opt);
        });
      }
    });
  } catch(err){ console.error(err); }
}

// Load videos
async function loadVideos(filter={}) {
  try {
    let url;
    if (!filter.category && !filter.subcategory) {
      // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹: ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
      url = `/users/${currentUser.id}`;
    } else {
      // Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙÙŠØ©: Ø§Ù„Ø¨Ø­Ø«
      url = `/videos/search?`;
      if(filter.category) url += `category=${filter.category}&`;
      if(filter.subcategory) url += `subcategory=${filter.subcategory}&`;
    }

    const res = await fetch(url, { headers:{ Authorization:'Bearer '+token }});
    if(!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª');

    let videos = [];
    if(url.startsWith('/users/')) {
      const data = await res.json();
      videos = data.videos || [];
    } else {
      videos = await res.json();
    }

    const grid = document.getElementById('videoGrid');
    grid.innerHTML = '';
    if(!videos.length){ grid.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</p>'; return; }

    videos.forEach(v=>{
      const card = createVideoCard(v);
      grid.appendChild(card);

      const delBtn = card.querySelector('.delete-btn');
      if(delBtn){
        delBtn.addEventListener('click', async()=>{
          if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ')) return;
          try{
            const resp = await fetch(`/videos/${v._id}`, { method:'DELETE', headers:{Authorization:'Bearer '+token}});
            const json = await resp.json();
            if(resp.ok){ card.remove(); alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'); } 
            else { alert(json.error||'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù'); }
          } catch(err){ console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù'); }
        });
      }
    });

    attachLikeButtons();

  } catch(err){
    console.error(err);
    document.getElementById('videoGrid').innerHTML = '<p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</p>';
  }
}

// Like buttons
async function toggleLike(videoId, btn){
  const liked = btn.classList.contains('liked');
  btn.classList.toggle('liked', !liked);
  btn.style.background = !liked ? '#e53e3e' : '#2575fc';
  btn.textContent = !liked ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ ğŸ’”' : 'Ø¥Ø¹Ø¬Ø§Ø¨ â¤ï¸';

  try{
    const res = await fetch(`/videos/${videoId}`, {
      method:'PATCH',
      headers:{ Authorization:'Bearer '+token,'Content-Type':'application/json' },
      body: JSON.stringify({ action: liked ? 'unlike' : 'like' })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
    const likesCount = data.likedBy ? data.likedBy.length : 0;
    btn.textContent = !liked ? `Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ ğŸ’” ${likesCount}` : `Ø¥Ø¹Ø¬Ø§Ø¨ â¤ï¸ ${likesCount}`;
  } catch(err){ console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'); }
}

function attachLikeButtons(){
  document.querySelectorAll('.like-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const card = btn.closest('.video-card');
      if(!card) return;
      toggleLike(card.dataset.videoId, btn);
    });
  });
}

// Filter button
document.getElementById('filterBtn').addEventListener('click', ()=>{
  loadVideos({ 
    category: document.getElementById('categorySelect').value,
    subcategory: document.getElementById('subcategorySelect').value
  });
});

// Initial load
loadCategories();
loadVideos(); // ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
</script>
</body>
</html>
